dc.ui.EditorToolbar=Backbone.View.extend({className:"editor_toolbar interface",constructor:function(){Backbone.View.apply(this,arguments);this.modes={};this.viewer=currentDocument;this.imageUrl=this.viewer.schema.document.resources.page.image},toggle:function(){if(this.modes.open=="is"){this.close();this.showSelectedThumbnail()}else{dc.app.editor.closeAllEditors();this.open()}},showSelectedThumbnail:function(){$(".DV-thumbnail.DV-originallySelected").removeClass("DV-originallySelected").addClass("DV-selected")},
hideSelectedThumbnail:function(){$(".DV-thumbnail.DV-selected").removeClass("DV-selected").addClass("DV-originallySelected")}});
dc.ui.AnnotationEditor=Backbone.View.extend({id:"annotation_editor",events:{"click .close":"close"},constructor:function(a){Backbone.View.call(this,a);this._open=false;this._buttons={};this._baseURL="/documents/"+dc.app.editor.docId+"/annotations";this._inserts=$(".DV-pageNoteInsert");this.redactions=[];_.bindAll(this,"open","close","drawAnnotation","saveAnnotation","deleteAnnotation","createPageNote");currentDocument.api.onAnnotationSave(this.saveAnnotation);currentDocument.api.onAnnotationDelete(this.deleteAnnotation);
this._inserts.click(this.createPageNote)},open:function(a){this._open=true;this._buttons[a]=$("#control_panel ."+a+"_annotation");this.pages=$(".DV-pages");this.page=$(".DV-page");this._guide=$("#"+a+"_note_guide");this.redactions=[];this.page.css({cursor:"crosshair"});a!="redact"&&this._inserts.filter(".visible").show().addClass("DV-"+a);this.page.bind("mousedown",this.drawAnnotation);$(document).bind("keydown",this.close);$(document.body).setMode(a,"editing");this._buttons[a].addClass("open");this._guide.fadeIn("fast")},
close:function(){this._open=false;this.page.css({cursor:""});this.page.unbind("mousedown",this.drawAnnotation);$(document).unbind("keydown",this.close);this.clearAnnotation();this.clearRedactions();this._inserts.hide().removeClass("DV-public DV-private");$(document.body).setMode(null,"editing");this._buttons[this._kind].removeClass("open");this._guide.hide()},toggle:function(a){if(this._open){this.close();if(a===this._kind)return}this.open(this._kind=a)},clearAnnotation:function(){this.region&&$(this.region).remove()},
clearRedactions:function(){$(".DV-annotationRegion.DV-accessRedact").remove()},createPageNote:function(a){this.close();a=$(a.target).closest(".DV-set");a=currentDocument.api.getPageNumberForId(a.attr("data-id"));currentDocument.api.addAnnotation({page:a,unsaved:true,access:this._kind||"public",owns_note:true})},drawAnnotation:function(a){a.stopPropagation();a.preventDefault();this._activePage=$(a.currentTarget);this._activePageNumber=currentDocument.api.getPageNumberForId($(this._activePage).closest(".DV-set").attr("data-id"));
this.clearAnnotation();var b=this._activePage.offset().top,c=this._activePage.offset().left,d=a.pageX-c,f=a.pageY-b,g=this._activePage.height()-6,i=this._activePage.width()-6;this.region=this.make("div",{"class":"DV-annotationRegion active "+this._accessClass(this._kind),style:"position:absolute;"});(this._kind=="redact"?this._specificPage():this._activePage).append(this.region);var j=function(e){var h=e.pageX-c-3;e=e.pageY-b-3;h=h<0?0:h>i?i:h;e=e<0?0:e>g?g:e;return{left:Math.min(d,h),top:Math.min(f,
e),width:Math.abs(h-d),height:Math.abs(e-f)}};$(this.region).css(j(a));var k=_.bind(function(e){$(this.region).css(j(e));return false},this),l=_.bind(function(e){$(document).unbind("keydown",this.close);this.pages.unbind("mouseup",l).unbind("mousemove",k);e=j(e);e.left-=1;e.top-=1;e.right=e.left+e.width;e.bottom=e.top+e.height;if(this._kind!="redact"){e.top+=2;e.left+=5;e.right+=15;e.bottom+=5}var h=currentDocument.api.relativeZoom(),m=_.map([e.top,e.right,e.bottom,e.left],function(n){return Math.round(n/
h)}).join(",");if(this._kind=="redact"){e.width>5&&e.height>5?this.redactions.push({location:m,page:this._activePageNumber}):$(this.region).remove();this.region=null}else{this.close();e.width>5&&e.height>5&&currentDocument.api.addAnnotation({location:{image:m},page:this._activePageNumber,unsaved:true,access:this._kind,owns_note:true})}return false},this);this.pages.bind("mouseup",l).bind("mousemove",k)},saveAnnotation:function(a){this[a.unsaved?"createAnnotation":"updateAnnotation"](a)},annotationToParams:function(a,
b){delete a.unsaved;var c={page_number:a.page,content:a.text,title:a.title,access:a.access};if(a.location)c.location=a.location.image;return _.extend(c,b||{})},createAnnotation:function(a){var b=this.annotationToParams(a);$.ajax({url:this._baseURL,type:"POST",data:b,dataType:"json",success:_.bind(function(c){a.server_id=c.id;this._adjustNoteCount(1,this._kind=="public"?1:0)},this)})},updateAnnotation:function(a){var b=this._baseURL+"/"+a.server_id;a=this.annotationToParams(a,{_method:"put"});$.ajax({url:b,
type:"POST",data:a,dataType:"json"})},deleteAnnotation:function(a){a.server_id&&$.ajax({url:this._baseURL+"/"+a.server_id,type:"POST",data:{_method:"delete"},dataType:"json",success:_.bind(function(){this._adjustNoteCount(-1,this._kind=="public"?-1:0)},this)})},_specificPage:function(){var a=$(".DV-pageSpecific-"+this._activePageNumber);if(a.length)return a;a=this.make("div",{"class":"DV-pageSpecific DV-pageSpecific-"+this._activePageNumber});this._activePage.append(a);return $(a)},_adjustNoteCount:function(a,
b){try{var c=parseInt(currentDocument.api.getId(),10),d=window.opener.Documents.get(c);if(d){d.set({annotation_count:(d.get("annotation_count")||0)+a});d.set({public_note_count:(d.get("public_note_count")||0)+b})}}catch(f){}},_accessClass:function(a){return"DV-access"+dc.inflector.capitalize(a)}});
dc.ui.ViewerControlPanel=Backbone.View.extend({id:"control_panel",events:{"click .set_sections":"openSectionEditor","click .public_annotation":"togglePublicAnnotation","click .private_annotation":"togglePrivateAnnotation","click .redact_annotation":"toggleRedaction","click .cancel_redactions":"toggleRedaction","click .save_redactions":"saveRedactions","click .edit_document_info":"editDocumentInfo","click .edit_description":"editDescription","click .edit_title":"editTitle","click .edit_source":"editSource",
"click .edit_access":"editAccess","click .edit_related_article":"editRelatedArticle","click .edit_document_url":"editPublishedUrl","click .edit_data":"editData","click .edit_remove_pages":"editRemovePages","click .edit_reorder_pages":"editReorderPages","click .edit_page_text":"editPageText","click .reprocess_text":"reprocessText","click .edit_replace_pages":"editReplacePages","click .toggle_document_info":"toggleDocumentInfo","click .embed_document":"embedDocument","click .embed_note":"embedNote",
"click .access_info":"editAccess"},initialize:function(){var a=this._getDocumentModel();_.bindAll(this,"closeDocumentOnAccessChange","onDocumentChange","render");a.bind("change:access",this.render);a.bind("change",this.onDocumentChange)},render:function(){var a=dc.model.Account.prototype;a=dc.account.role==a.ADMINISTRATOR||dc.account.role==a.CONTRIBUTOR;this.viewer=currentDocument;this._page=this.viewer.$(".DV-textContents");var b=this._getDocumentModel().get("access");$(this.el).html(JST.control_panel({isReviewer:dc.app.editor.options.isReviewer,
isOwner:dc.app.editor.options.isOwner,workspacePrefix:a?"#":"",docAccess:b,orgName:this.viewer.api.getContributorOrganization()}));this.showReviewerWelcome();return this},showReviewerWelcome:function(){var a=dc.app.editor.options.reviewerInviter;if(dc.account.role==dc.model.Account.prototype.REVIEWER&&a){var b=a.fullName+' has invited you to review "'+dc.inflector.truncate(currentDocument.api.getTitle(),50)+'"';a=JST.reviewer_welcome(a);b=dc.ui.Dialog.alert("",{description:a,title:b});$(b.el).addClass("wide_dialog");
b.center()}},openSectionEditor:function(){dc.app.editor.sectionEditor.open()},prompt:function(a,b,c,d){dc.ui.Dialog.prompt(a,b,function(f,g){if(b!=f)return c(f,g);return true},d)},editDocumentInfo:function(a){if(!$(a.target).is(".toggle_document_info")){a=this._getDocumentModel();new dc.ui.DocumentDialog([a])}},editTitle:function(){this.prompt("Title",this.viewer.api.getTitle(),_.bind(function(a){this.viewer.api.setTitle(a);this._updateDocument({title:a});return true},this),{mode:"short_prompt"})},
editSource:function(){this.prompt("Source",this.viewer.api.getSource(),_.bind(function(a){this.viewer.api.setSource(a);this._updateDocument({source:a});return true},this),{mode:"short_prompt"})},editRelatedArticle:function(){this.prompt("Related Article URL",this.viewer.api.getRelatedArticle(),_.bind(function(a,b){if((a=dc.inflector.normalizeUrl(a))&&!b.validateUrl(a))return false;this.viewer.api.setRelatedArticle(a);this._updateDocument({related_article:a});return true},this),{mode:"short_prompt",
description:"Enter the URL of the article that references this document:"})},editPublishedUrl:function(){this.prompt("Published URL",this.viewer.api.getPublishedUrl(),_.bind(function(a,b){if((a=dc.inflector.normalizeUrl(a))&&!b.validateUrl(a))return false;this.viewer.api.setPublishedUrl(a);this._updateDocument({remote_url:a});return true},this),{mode:"short_prompt",description:"Enter the URL of the page on which this document is embedded:"})},editDescription:function(){this.prompt("Description",this.viewer.api.getDescription(),
_.bind(function(a){this.viewer.api.setDescription(a);this._updateDocument({description:a});return true},this))},editAccess:function(){Documents.editAccess([this.docModel],this.closeDocumentOnAccessChange)},editData:function(){new dc.ui.DocumentDataDialog([this.docModel])},closeDocumentOnAccessChange:function(){if(this.docModel.hasChanged("access")){this.setOnParent(this.docModel,{access:dc.access.PENDING});dc.ui.Dialog.alert("Changing the access level will take a few moments. Please close this document.",
{onClose:function(){window.close()}})}},onDocumentChange:function(a){this.viewer.api.setTitle(a.get("title"));this.viewer.api.setSource(a.get("source"));this.viewer.api.setRelatedArticle(a.get("related_article"));this.viewer.api.setPublishedUrl(a.get("remote_url"));this.viewer.api.setDescription(a.get("description"));this.setOnParent(a,{title:a.get("title"),source:a.get("source"),related_article:a.get("related_article"),remote_url:a.get("remote_url"),description:a.get("description"),access:a.get("access"),
data:_.clone(a.get("data"))});a.hasChanged("access")&&this.closeDocumentOnAccessChange()},reprocessText:function(){var a=this,b=new dc.ui.Dialog.confirm('Reprocess this document to take         advantage of improvements to our text extraction tools. Choose         "Force OCR" (optical character recognition) to ignore any embedded         text information and use Tesseract before reprocessing. The document will         close while it\'s being rebuilt. Are you sure you want to proceed? ',function(){var d=
a._getDocumentModel();d.reprocessText();a.setOnParent(d,{access:dc.access.PENDING});$(b.el).remove();_.defer(dc.ui.Dialog.alert,"The text is being processed. Please close this document.",{onClose:function(){window.close()}})},{width:450}),c=$(b.make("span",{"class":"minibutton dark center_button"},"Force OCR")).bind("click",function(){var d=a._getDocumentModel();d.reprocessText(true);a.setOnParent(d,{access:dc.access.PENDING});$(b.el).remove();_.defer(dc.ui.Dialog.alert,"The text is being processed. Please close this document.",
{onClose:function(){window.close()}})});b.$(".ok").text("Reprocess").before(c)},openTextTab:function(){this.viewer.state!="ViewText"&&this.viewer.open("ViewText")},openThumbnailsTab:function(){this.viewer.state!="ViewThumbnails"&&this.viewer.open("ViewThumbnails")},openDocumentTab:function(){this.viewer.state!="ViewDocument"&&this.viewer.open("ViewDocument")},editPageText:function(){this.openTextTab();dc.app.editor.editPageTextEditor.toggle()},editReplacePages:function(){this.openThumbnailsTab();
dc.app.editor.replacePagesEditor.toggle()},editRemovePages:function(){this.openThumbnailsTab();dc.app.editor.removePagesEditor.toggle()},editReorderPages:function(){this.openThumbnailsTab();dc.app.editor.reorderPagesEditor.toggle()},togglePublicAnnotation:function(){this.openDocumentTab();dc.app.editor.annotationEditor.toggle("public")},togglePrivateAnnotation:function(){this.openDocumentTab();dc.app.editor.annotationEditor.toggle("private")},toggleRedaction:function(){this.openDocumentTab();dc.app.editor.annotationEditor.toggle("redact")},
toggleDocumentInfo:function(){var a=$(".edit_document_fields").is(":visible");$(".document_fields_container").setMode(a?"hide":"show","document_fields");$(".document_fields_container .toggle").setMode(a?"not":"is","enabled")},embedDocument:function(){var a=this._getDocumentModel();(new dc.ui.DocumentEmbedDialog(a)).render()},embedNote:function(){var a=this._getDocumentModel();Documents.refresh([a]);dc.app.noteEmbedDialog=new dc.ui.NoteEmbedDialog(a)},saveRedactions:function(){var a=this.viewer.api.getModelId(),
b=dc.app.editor.annotationEditor.redactions;if(!b.length)return dc.app.editor.annotationEditor.close();var c="You've redacted "+b.length+" "+dc.inflector.pluralize("passage",b.length)+". This document will close while it's being rebuilt. Are you sure you're ready to proceed?";dc.ui.Dialog.confirm(c,_.bind(function(){$.ajax({url:"/documents/"+a+"/redact_pages",type:"POST",data:{redactions:JSON.stringify(b)},dataType:"json",success:_.bind(function(d){this.setOnParent(a,d);window.close();_.defer(dc.ui.Dialog.alert,
"The document is being redacted. Please close this document.")},this)});return true},this))},setOnParent:function(a,b){try{(a=window.opener&&window.opener.Documents&&window.opener.Documents.get(a))&&a.set(b)}catch(c){}},_getDocumentModel:function(){if(this.docModel)return this.docModel;this.docModel=new dc.model.Document(window.currentDocumentModel);this.docModel.viewerEditable=dc.account.isOwner;this.docModel.suppressNotifier=true;return this.docModel},_updateDocument:function(a){var b=this._getDocumentModel();
b.save(a);this.setOnParent(b,a)}});
dc.ui.EditPageTextEditor=dc.ui.EditorToolbar.extend({id:"edit_page_text_container",events:{"click .edit_page_text_confirm_input":"confirmEditPageText","click .document_page_tile_remove":"resetPage","click .close_editor":"close"},initialize:function(a){this.editor=a.editor;_.bindAll(this,"cachePageText")},_resetState:function(){this.originalPageText={};this.pageText={}},findSelectors:function(){this.$s={guide:$("#edit_page_text_guide"),guideButton:$(".edit_page_text.button"),page:$(".DV-text"),pages:$(".DV-pages"),
viewerContainer:$(".DV-docViewer-Container"),header:$("#edit_page_text_container"),container:null,saveButton:$(".edit_page_text_confirm_input",this.el),headerTiles:$(".document_page_tiles",this.el)}},open:function(){$(this.el).show();this.findSelectors();this._resetState();this.setMode("is","open");this.viewer.api.enterEditPageTextMode();this.render()},render:function(){$(this.el).html(JST.edit_page_text({}));this.$s.viewerContainer.append(this.el);this.viewer.state!="ViewText"&&this.viewer.open("ViewText");
this.$s.pages.addClass("edit_page_text_viewer");this.$s.container=$(this.el);this.findSelectors();this.$s.guideButton.addClass("open");this.$s.guide.fadeIn("fast");this.$s.saveButton.setMode("not","enabled");this.$s.header.removeClass("active");this.handleEvents()},handleEvents:function(){$(".DV-textContents").parent().delegate(".DV-textContents","keyup",this.cachePageText).delegate(".DV-textContents","change",this.cachePageText)},getPageNumber:function(){return this.viewer.api.currentPage()},getPageText:function(a){a=
a||this.getPageNumber();return this.viewer.api.getPageText(a)},confirmEditPageText:function(){var a=this.getChangedPageTextPages(),b=this.viewer.api.getModelId(),c=dc.ui.Dialog.progress("Saving text edits&hellip;");$.ajax({url:"/documents/"+b+"/save_page_text",type:"POST",data:{modified_pages:JSON.stringify(a)},dataType:"json",success:_.bind(function(d){try{window.opener&&window.opener.Documents&&window.opener.Documents.get(b).set(d)}catch(f){}window.close();c.close();this.viewer.api.resetPageText(true);
_.defer(dc.ui.Dialog.alert,"The page text is being saved. Please close this document.")},this)})},setSaveState:function(){this.editor.setSaveState(!!_.keys(this.pageText).length)},cachePageText:function(){var a=this.getPageNumber(),b=dc.inflector.trim($(".DV-textContents").textWithNewlines());a in this.originalPageText||(this.originalPageText[a]=$.trim(this.getPageText(a)));if(b!=this.originalPageText[a]){a in this.pageText||this.redrawHeader();this.pageText[a]=b}else{delete this.originalPageText[a];
delete this.pageText[a];this.redrawHeader()}this.setSaveState();this.viewer.api.setPageText(b,a)},resetPage:function(a){a=$(a.currentTarget).parents(".document_page_tile").attr("data-pageNumber");this.viewer.api.setPageText(this.originalPageText[a],a);this.viewer.api.enterEditPageTextMode();delete this.originalPageText[a];delete this.pageText[a];this.setSaveState();this.redrawHeader()},redrawHeader:function(){var a;a=_.keys(this.originalPageText);var b=a.length;a=a.sort(function(c,d){return c-d});
$(".document_page_tile",this.$s.headerTiles).empty().remove();if(b==0){this.$s.header.removeClass("active");this.$s.saveButton.setMode("not","enabled")}else{this.$s.header.addClass("active");this.$s.saveButton.setMode("is","enabled")}_.each(a,_.bind(function(c){var d=this.imageUrl;d=d.replace(/\{size\}/,"thumbnail");d=d.replace(/\{page\}/,c);d=$(JST.document_page_tile({url:d,pageNumber:c}));d.attr("data-pageNumber",c);this.$s.headerTiles.append(d)},this));a=b==0?"Save page text":"Save "+b+dc.inflector.pluralize(" page",
b);$(".edit_page_text_confirm_input",this.el).val(a);a=$(".document_page_tile").length*$(".document_page_tile").eq(0).outerWidth(true);b=$(".editor_toolbar_controls",this.el).outerWidth(true);this.$s.headerTiles.width(a+b+10);Backbone.View.prototype.delegateEvents.call(this)},getChangedPageTextPages:function(){var a={};_.each(this.pageText,_.bind(function(b,c){if(this.originalPageText[c]!=b)a[c]=b},this));return a},close:function(){if(this.modes.open=="is"){this._resetState();this.setSaveState();
this.setMode("not","open");this.$s.guideButton.removeClass("open");this.$s.guide.hide();this.$s.pages.removeClass("edit_page_text_viewer");$(".DV-textContents").attr("contentEditable",false).removeClass("DV-editing");$(this.el).hide();this.viewer.api.leaveEditPageTextMode()}}});
dc.ui.RemovePagesEditor=dc.ui.EditorToolbar.extend({id:"remove_pages_container",events:{"click .document_page_tile_remove":"removePageFromRemoveSet","click .remove_pages_confirm_input":"confirmRemovePages","click .close_editor":"close"},initialize:function(a){this.editor=a.editor},findSelectors:function(){this.$s={guide:$("#edit_remove_pages_guide"),guideButton:$(".edit_remove_pages"),thumbnails:$(".DV-thumbnail"),thumbnailsContainer:$(".DV-thumbnails"),pages:$(".DV-pages"),viewerContainer:$(".DV-docViewer-Container"),
saveButton:this.$(".remove_pages_confirm_input"),holder:null,container:null}},open:function(){$(this.el).show();this.findSelectors();this.removePages=[];this.setMode("is","open");this.$s.guide.fadeIn("fast");this.$s.guideButton.addClass("open");this.viewer.api.enterRemovePagesMode();this.hideSelectedThumbnail();this.render()},render:function(){$(this.el).show().html(JST.remove_pages({}));this.$s.viewerContainer.append(this.el);this.viewer.state!="ViewDocument"&&this.viewer.state!="ViewThumbnails"&&
this.viewer.open("ViewThumbnails");this.$s.pages.addClass("remove_pages_viewer");this.$s.thumbnails.removeClass("DV-selected");this.$s.holder=$(".remove_pages_page_container",this.el);this.$s.container=$(this.el);this.$s.saveButton.setMode("not","enabled");this.redrawPages();this.handleEvents()},unbindEvents:function(){this.$s.thumbnailsContainer.unbind("mousedown.dv-remove")},handleEvents:function(){this.unbindEvents();this.$s.thumbnailsContainer.bind("mousedown.dv-remove",_.bind(function(a){a=$(a.target);
if(a.closest(".DV-thumbnail-page").length!=0){a=a.closest(".DV-thumbnail");$(".DV-pageImage,.DV-thumbnail-image img",a).eq(0).attr("src");a=a.attr("data-pageNumber");_.contains(this.removePages,a)?this.removePageNumberFromRemoveSet(a):this.addPageToRemoveSet(a)}},this))},addPageToRemoveSet:function(a){if(!_.contains(this.removePages,a)){this.viewer.api.addPageToRemovedPages(a);this.removePages.push(a);this.redrawPages();this.$s.thumbnails.eq(a-1).addClass("DV-selected")}},removePageFromRemoveSet:function(a){this.removePageNumberFromRemoveSet($(a.target).parents(".document_page_tile").attr("data-pageNumber"))},
removePageNumberFromRemoveSet:function(a){this.removePages=_.reject(this.removePages,function(b){return b==a});this.redrawPages();this.viewer.api.removePageFromRemovedPages(a);this.$s.thumbnails.eq(a-1).removeClass("DV-selected")},redrawPages:function(){var a=this.removePages.length;this.editor.setSaveState(!!a);this.removePages=this.removePages.sort(function(c,d){return c-d});$(".document_page_tile",this.$s.holder).empty().remove();if(a==0){this.$s.container.addClass("empty");this.$(".remove_pages_confirm_input").setMode("not",
"enabled")}else{this.$s.container.removeClass("empty");this.$(".remove_pages_confirm_input").setMode("is","enabled")}_.each(this.removePages,_.bind(function(c){var d=this.imageUrl;d=d.replace(/\{size\}/,"thumbnail");d=d.replace(/\{page\}/,c);d=$(JST.document_page_tile({url:d,pageNumber:c}));d.attr("data-pageNumber",c);this.$s.holder.append(d)},this));a="Remove "+(a?a:"")+dc.inflector.pluralize(" Page",a);this.$(".remove_pages_confirm_input").text(a);a=$(".document_page_tile").length*$(".document_page_tile").eq(0).outerWidth(true);
var b=$(".editor_toolbar_controls",this.el).outerWidth(true);this.$s.holder.width(a+b+10)},confirmRemovePages:function(){var a=this.removePages.length;if(a)if(a>=this.viewer.api.numberOfPages())dc.ui.Dialog.alert("You can't remove all the pages from this document.");else{a="You've selected "+a+dc.inflector.pluralize(" page",a)+" for removal. This document will close while it's being rebuilt. Are you sure you're ready to proceed?";dc.ui.Dialog.confirm(a,_.bind(function(){this.$s.saveButton.text("Removing...").attr("disabled",
true).setMode("not","enabled");this.save();return true},this))}},save:function(){dc.ui.Dialog.progress("Removing Pages&hellip;");var a=this.viewer.api.getModelId();$.ajax({url:"/documents/"+a+"/remove_pages",type:"POST",data:{pages:this.removePages},dataType:"json",success:function(b){try{window.opener&&window.opener.Documents&&window.opener.Documents.get(a).set(b)}catch(c){}window.close();_.defer(dc.ui.Dialog.alert,"The pages are being removed. Please close this document.")}})},close:function(){if(this.modes.open==
"is"){this.editor.setSaveState();this.setMode("not","open");this.$s.guide.hide();this.$s.guideButton.removeClass("open");this.$s.pages.removeClass("remove_pages_viewer");this.$s.thumbnails.removeClass("DV-selected");this.unbindEvents();$(this.el).empty().hide();this.viewer.api.leaveRemovePagesMode()}}});
dc.ui.ReorderPagesEditor=dc.ui.EditorToolbar.extend({id:"reorder_pages_container",events:{"click .reorder_pages_confirm_input":"confirmReorderPages","click .close_editor":"close"},initialize:function(a){this.editor=a.editor},findSelectors:function(){this.$s={guide:$("#edit_reorder_pages_guide"),guideButton:$(".edit_reorder_pages"),page:$(".DV-page,.DV-thumbnail"),thumbnails:$(".DV-thumbnails"),pages:$(".DV-pages"),viewerContainer:$(".DV-docViewer-Container"),header:$("#reorder_pages_container"),container:null,
saveButton:$(".reorder_pages_confirm_input")}},open:function(){$(this.el).show();this.findSelectors();this.setMode("is","open");this.viewer.api.enterReorderPagesMode();this.viewer.api.resetReorderedPages();this.render();this.orderChanged=false;this.$s.guide.fadeIn("fast");this.$s.guideButton.addClass("open");this.$s.saveButton.setMode("not","enabled");this.hideSelectedThumbnail()},render:function(){$(this.el).html(JST.reorder_pages({}));this.$s.viewerContainer.append(this.el);this.findSelectors();
this.viewer.state!="ViewThumbnails"&&this.viewer.open("ViewThumbnails");this.$s.pages.addClass("reorder_pages_viewer");this.$s.container=$(this.el);$(".DV-currentPageImage",this.$s.thumbnails).removeClass("DV-currentPageImage").addClass("DV-currentPageImage-disabled");this.handleEvents();this.initialOrder=this.serializePageOrder()},handleEvents:function(){var a=this.$s.thumbnails;$(".DV-thumbnail",a).each(function(b){$(this).attr("data-pageNumber",b+1)});$(".DV-currentPageImage",a).removeClass("DV-currentPageImage").addClass("DV-currentPageImage-disabled");
jQuery(".DV-thumbnails").sortable({containment:".DV-thumbnails",items:".DV-thumbnail",handle:".DV-thumbnail-page",cursor:"move",scrollSensitivity:80,scrollSpeed:15,tolerance:"pointer",zIndex:10,stop:_.bind(function(){this.refreshHeader()},this)})},refreshHeader:function(){var a=!_.isEqual(this.serializePageOrder(),this.initialOrder);this.orderChanged=a;this.$s.saveButton.setMode(a?"is":"not","enabled");this.editor.setSaveState(a)},confirmReorderPages:function(){this.orderChanged&&dc.ui.Dialog.confirm("You've reordered the pages in this document. The document will close while it's being rebuilt. Are you sure you're ready to proceed?",
_.bind(function(){$("input.reorder_pages_confirm_input",this.el).val("Reordering...").attr("disabled",true);this.save();return true},this))},serializePageOrder:function(){var a=[];$(".DV-thumbnail",this.$s.thumbnails).each(function(){a.push(parseInt($(this).attr("data-pageNumber"),10))});return a},save:function(){dc.ui.Dialog.progress("Reordering Pages&hellip;");var a=this.serializePageOrder(),b=this.viewer.api.getModelId();$.ajax({url:"/documents/"+b+"/reorder_pages",type:"POST",data:{page_order:a},
dataType:"json",success:function(c){try{window.opener&&window.opener.Documents&&window.opener.Documents.get(b).set(c)}catch(d){}window.close();_.defer(dc.ui.Dialog.alert,"The pages are being reordered. Please close this document.")}})},close:function(){if(this.modes.open=="is"){this.editor.setSaveState();$(".DV-currentPageImage-disabled",this.$s.page).addClass("DV-currentPageImage").removeClass("DV-currentPageImage-disabled");this.setMode("not","open");jQuery(".DV-thumbnails").sortable("destroy");
this.$s.guide.hide();this.$s.guideButton.removeClass("open");this.$s.pages.removeClass("reorder_pages_viewer");$(this.el).hide();this.viewer.api.leaveReorderPagesMode()}}});
dc.ui.ReplacePagesEditor=dc.ui.EditorToolbar.extend({id:"replace_pages_container",events:{"click .close_editor":"close"},initialize:function(a){this.editor=a.editor},findSelectors:function(){this.$s={guide:$("#edit_replace_pages_guide"),guideButton:$(".edit_replace_pages"),thumbnails:$(".DV-thumbnail"),thumbnailImages:$(".DV-thumbnail .DV-thumbnail-image"),pages:$(".DV-pages"),viewerContainer:$(".DV-docViewer-Container"),hint:this.$(".editor_hint"),container:null}},open:function(){$(this.el).show();
this.findSelectors();this.setMode("is","open");this.$s.guide.fadeIn("fast");this.$s.guideButton.addClass("open");this.viewer.api.enterReplacePagesMode();this.render();this.hideSelectedThumbnail();this.resetSelected()},resetSelected:function(){$(".DV-currentPageImage",this.$s.pages).removeClass("DV-currentPageImage").addClass("DV-currentPageImage-disabled");this.$s.thumbnails.removeClass("DV-selected");this.$s.thumbnails.find(".left_chosen,.right_chosen").removeClass("left_chosen").removeClass("right_chosen")},
render:function(){this.viewer.state!="ViewThumbnails"&&this.viewer.open("ViewThumbnails");$(this.el).html(JST.replace_pages({}));this.$s.viewerContainer.append(this.el);this.$s.pages.addClass("replace_pages_viewer");this.$s.container=$(this.el);this.findSelectors();this.updateHint("choose");dc.app.uploader=new dc.ui.UploadDialog({editable:false,insertPages:true,autostart:true,documentId:this.viewer.api.getModelId()});dc.app.uploader.setupUpload();this.handleEvents();this.delegateEvents()},unbindEvents:function(){var a=
this.$s.thumbnailImages;this.$s.thumbnails.unbind("mouseout.dv-replace").unbind("mousemove.dv-replace").unbind("mousedown.dv-replace").unbind("mouseover.dv-replace").unbind("mouseenter.dv-replace").unbind("mouseleave.dv-replace");a.unbind("mouseout.dv-replace").unbind("mouseover.dv-replace")},handleEvents:function(){var a=this.$s.thumbnails,b=this.$s.thumbnailImages;this.unbindEvents();a.each(function(c){$(this).attr("data-pageNumber",c+1)});a.bind("mouseover.dv-replace",function(){$(this).addClass("DV-hover-thumbnail")});
a.bind("mouseout.dv-replace",function(){$(".DV-overlay",this).removeClass("left").removeClass("right");$(this).removeClass("DV-hover-thumbnail")});a.bind("mousemove.dv-replace",function(c){var d=$(this);if(!d.hasClass("DV-hover-image")){d.attr("data-pageNumber");var f=d.offset(),g=d.outerWidth(true);c=(c.clientX-f.left)/g;$(".DV-overlay",d).removeClass("left").removeClass("right").addClass(c<0.2?"left":c>0.8?"right":"")}});a.bind("mousedown.dv-replace",_.bind(function(c){c.preventDefault();c.stopPropagation();
this.confirmPageChoice($(c.currentTarget))},this));b.bind("mouseover.dv-replace",function(){$(this).closest(".DV-thumbnail").addClass("DV-hover-image")});b.bind("mouseout.dv-replace",function(){$(this).closest(".DV-thumbnail").removeClass("DV-hover-image")})},confirmPageChoice:function(a){var b=this.$s.thumbnails,c=true;this.resetSelected();if(dc.app.hotkeys.shift&&this.$firstPageSelection&&this.$firstPageSelection.length){c=parseInt(this.$firstPageSelection.attr("data-pageNumber"),10);var d=parseInt(a.attr("data-pageNumber"),
10),f=Math.max(d,c),g=Math.min(d,c);d=c>d;var i=$(".DV-overlay",a).hasClass("left"),j=$(".DV-overlay",a).hasClass("right");c=false;if(!a.hasClass("DV-hover-image"))if(i&&d)f-=1;else if(i&&!d)f-=1;else if(j&&d){g+=1;f-=1}if(!i&&!j&&d)f-=1;if(d&&!this.isFirstPageBetween)f+=1;if(f<g)c=true;if(!c){b=b.filter(function(){var k=$(this).attr("data-pageNumber");return g<=k&&k<=f});b.addClass("DV-selected");this.updateHint("replace")}}if(c)if(a.hasClass("DV-hover-image")){this.$firstPageSelection=a;this.isFirstPageBetween=
false;a.addClass("DV-selected");this.updateHint("replace")}else if(a.hasClass("DV-hover-thumbnail")){c=$(".left",b);b=$(".right",b);if(c.length){c.addClass("left_chosen");this.$firstPageSelection=a}else if(b.length){b.addClass("right_chosen");this.$firstPageSelection=a.next();if(!this.$firstPageSelection.length)this.$firstPageSelection=a}else{this.updateHint("choose");return false}this.isFirstPageBetween=true;this.updateHint("insert")}},updateHint:function(a){var b,c,d;if(a=="choose"){b="Choose a location to insert pages.";
$(this.el).setMode("off","upload");this.$(".replace_pages_upload_button").setMode("not","enabled")}else{var f=a=="replace";$(this.el).setMode("on","upload");this.$(".replace_pages_upload_button").setMode("is","enabled");b=f?"Replace ":"Insert ";if(f){c=this.getPageRange();b+=c.start!=c.end?"pages "+c.start+" through "+c.end+".":"page "+c.start+"."}else if(a=="insert"){a=this.viewer.api.numberOfPages();d=this.getInsertPageNumber();if(d<1)b+="before the first page.";else if(d<a)b+="between pages "+
d+" and "+(d+1)+".";else if(d>=a)b+="after the last page."}dc.app.uploader.insertPagesAttrs({insertPageAt:d,replacePagesStart:c&&c.start,replacePagesEnd:c&&c.end})}this.$s.hint.text(b)},getPageRange:function(){var a=this.$s.thumbnails.filter(".DV-selected"),b=_.map(a,function(c){return parseInt($(c).attr("data-pageNumber"),10)});a=_.min(b);b=_.max(b);return{start:a,end:b}},getInsertPageNumber:function(){var a=this.$s.thumbnails.has(".left,.right"),b=parseInt(a.attr("data-pageNumber"),10);if(a.find(".left").length)return b-
1;else if(a.find(".right").length)return b},close:function(){if(this.modes.open=="is"){$(".DV-currentPageImage-disabled",this.$s.pages).addClass("DV-currentPageImage").removeClass("DV-currentPageImage-disabled");$(".left_chosen").removeClass("left_chosen");$(".right_chosen").removeClass("right_chosen");$(".DV-selected").removeClass("DV-selected");this.setMode("not","open");this.$s.guide.hide();this.unbindEvents();this.$s.guideButton.removeClass("open");this.$s.pages.removeClass("replace_pages_viewer");
$(this.el).hide();this.viewer.api.leaveReplacePagesMode()}}});
dc.ui.SectionEditor=Backbone.View.extend({constructor:function(a){Backbone.View.call(this,a);_.bindAll(this,"addRow","saveSections","removeAllSections")},open:function(){if(this.dialog)return false;this.sections=_.sortBy(currentDocument.api.getSections(),function(a){return parseInt(a.pageNumber,10)});this.dialog=(new dc.ui.Dialog({title:"Edit Sections",information:"Please add a title and page number for each section.",id:"section_editor",mode:"confirm",saveText:"Save",onClose:_.bind(function(){this.dialog=
null},this),onConfirm:_.bind(function(){return this.saveSections(this.serializeSections())},this)})).render();this.sectionsEl=$(this.make("ul",{id:"section_rows","class":"not_draggable"}));this.removeEl=$(this.make("div",{"class":"minibutton warn remove_all"},"Remove All"));this.removeEl.bind("click",this.removeAllSections);this.dialog.append(this.sectionsEl);this.dialog.addControl(this.removeEl);this.renderSections()},saveSections:function(a){var b=_.pluck(a,"page_number");if(b.length>_.uniq(b).length)return this.dialog.error("Can't create a duplicate section.");
if(this.impossibleSections(a))return this.dialog.error("Can't create a section outside the document.");$.ajax({url:"/sections/set",type:"POST",data:{sections:JSON.stringify(a),document_id:dc.app.editor.docId},dataType:"json"});this.updateNavigation(a);return true},removeAllSections:function(){this.saveSections([]);this.dialog.close()},impossibleSections:function(a){var b=currentDocument.api.numberOfPages();return _.any(a,function(c){return c.page_number<1||c.page_number>b})},serializeSections:function(){var a=
[];$(".section_row").each(function(b,c){var d=$("input",c).val(),f=parseInt($(".page_number",c).val(),10);d&&a.push({title:d,page_number:f,page:f})});return a},renderSections:function(){var a=this;if(!_.any(this.sections))return _.each(_.range(3),function(){a.addRow()});_.each(this.sections,function(b){a.addRow({title:b.title,page_number:b.page})})},updateNavigation:function(a){a=_.map(a,function(b){return _.extend({page:b.page_number},b)});currentDocument.api.setSections(a)},addRow:function(a){a=
_.extend({pageCount:currentDocument.api.numberOfPages(),title:"",page_number:""},a);var b=$(JST.section_row(a));$(".section_title",b).val(a.title).placeholder();$(".minus",b).bind("click",function(){b.remove()});$(".plus",b).bind("click",_.bind(function(){this.addRow({after:b})},this));if(a.after)return a.after.after(b);this.sectionsEl.append(b)}});
(function(){window.JST=window.JST||{};window.JST.control_panel=_.template('<% if (docAccess != dc.access.PUBLIC) { %><div class="access_info">  <span>    <%= docAccess == dc.access.ORGANIZATION ? \'Private to \' + orgName : \'Private Access\' %>  </span></div><% } %><div class="control_panel_title gradient_light">  <span class="">Document Tools</span></div><% if (isOwner || isReviewer) { %>  <div class="public_annotation button">    <div class="icon mini_note"></div>    <div class="icon cancel_search"></div>    <span>Add a Public Note</span>  </div>  <div id="public_note_guide" class="note_guide" style="display:none;">    Highlight a portion of the page, or click between pages to create a note.    <br /><br />    <span class="warn">Public notes are visible to everyone who views this document.</span>  </div><% } %><div class="private_annotation button">  <div class="icon mini_note_private"></div>  <div class="icon cancel_search"></div>  <span>Add a Private Note</span></div><div id="private_note_guide" class="note_guide" style="display:none;">  Highlight a portion of the page, or click between pages to create a note.  <br /><br />  <span class="warn">No one apart from you is ever allowed to view your private notes.</span></div><% if (isOwner || isReviewer) { %>  <div class="redact_annotation button">    <div class="icon mini_redaction"></div>    <div class="icon cancel_search"></div>    <span>Redact Document</span>  </div>  <div id="redact_note_guide" class="note_guide" style="display:none;">    Click and drag to draw a black rectangle over each portion of the document     you\'d like to redact. Associated text will be removed when you save your redactions.    <br /><br />    Any existing notes are temporarily hidden while redaction is taking place.    <br /><br />    <div class="minibutton cancel_redactions">Cancel</div>    <div class="minibutton default save_redactions">Save Redactions</div>  </div> <% } %> <% if (isOwner) { %>  <div class="set_sections button"><span>Edit Sections</span></div>  <div class="document_fields_container">    <div class="edit_document_info button">      <div class="icon toggle toggle_document_info"></div>      <span>Edit Document Info</span>    </div>    <div class="edit_document_fields">      <div class="edit_title button"><span class="dash">\u2013</span>&nbsp; <span>Edit Title</span></div>      <div class="edit_source button"><span class="dash">\u2013</span>&nbsp; <span>Edit Source</span></div>      <div class="edit_description button"><span class="dash">\u2013</span>&nbsp; <span>Edit Description</span></div>      <div class="edit_access button"><span class="dash">\u2013</span>&nbsp; <span>Edit Access Level</span></div>      <div class="edit_related_article button"><span class="dash">\u2013</span>&nbsp; <span>Edit Related Article URL</span></div>      <div class="edit_document_url button"><span class="dash">\u2013</span>&nbsp; <span>Edit Published URL</span></div>    </div>  </div>    <div class="edit_data button"><span>Edit Document Data</span></div>    <div class="control_panel_title gradient_light">    <span class="">Embed Tools</span>  </div>  <div class="embed_document button">    <span>Embed this Document</span>  </div>  <div class="embed_note button">    <span>Embed a Note</span>  </div>    <div class="control_panel_title gradient_light">    <span class="">Page Tools</span>  </div>  <div class="edit_replace_pages button">    <div class="icon cancel_search"></div>    <span>Insert/Replace Pages</span>  </div>  <div id="edit_replace_pages_guide" class="note_guide" style="display:none;">    To insert new pages at a specific position within the document, click    in between the pages above. If you\'d like to replace a specific page with a new copy,     click on the page you\'d like to remove.    <br /><br />    Hold down the shift key to select multiple pages to replace at once. When    you\'re ready, click the "Upload Pages" button.  </div>  <div class="edit_remove_pages button">    <div class="icon cancel_search"></div>    <span>Remove Pages</span>  </div>  <div id="edit_remove_pages_guide" class="note_guide" style="display:none;">    Click on each page you want to remove from this document.    <br /><br />    When you\'re finished selecting pages, click the "Remove Pages" button.  </div>  <div class="edit_reorder_pages button">    <div class="icon cancel_search"></div>    <span>Reorder Pages</span>  </div>  <div id="edit_reorder_pages_guide" class="note_guide" style="display:none;">    Drag and drop pages to change their position in the document.    <br /><br />    When you\'re finished rearranging, click on the "Save Page Order" button     to save your changes.  </div>    <div class="control_panel_title gradient_light">    <span class="">Text Tools</span>  </div>  <div class="edit_page_text button">    <div class="icon cancel_search"></div>    <span>Edit Page Text</span>  </div>  <div id="edit_page_text_guide" class="note_guide" style="display:none;">    Edit the text of any page: use the navigation arrows at the top to page     through this document. Editing the text here will not alter the original PDF.    <br /><br />    When you\u2019re finished revising the text, click the \u201cSave Text\u201d button.  </div>  <div class="reprocess_text button">    <span>Reprocess Text</span>  </div><% } %><div class="control_panel_help">  Our <a href="/<%= workspacePrefix %>help" target="_blank">help pages</a> can help you get the   most out of our <a href="/<%= workspacePrefix %>help/notes" target="_blank">annotation</a> and   <a href="/<%= workspacePrefix %>help/modification" target="_blank">modification</a> tools.</div>');window.JST.document_page_tile=
_.template('<div class="document_page_tile">  <img src="<%= url %>" />  <div class="document_page_line">    <div class="document_page_tile_remove cancel_search icon"></div>    <div class="document_page_tile_number">p. <%= pageNumber %></div>  </div></div>');window.JST.edit_page_text=_.template('<div class="edit_page_text">  <div class="editor_toolbar_controls edit_page_text_holder">    <div class="minibutton edit_page_text_confirm_input default not_enabled">Save Text</div>    <div class="minibutton close_editor">Cancel</div>  </div>    <div class="document_page_tiles"></div>    <div class="editor_hint edit_page_text_confirm_info">Edit the text of any page.<br />Change pages with the arrows on the right.</div>  </div>');
window.JST.remove_pages=_.template('<div class="remove_pages">    <div class="editor_toolbar_controls remove_pages_holder">    <div class="minibutton remove_pages_confirm_input default not_enabled"></div>    <div class="minibutton close_editor">Cancel</div>  </div>    <div class="remove_pages_page_container"></div>    <div class="editor_hint">Select the pages you wish to remove.</div>  </div>');window.JST.reorder_pages=_.template('<div class="reorder_pages">    <div class="editor_toolbar_controls reorder_pages_holder">    <div class="minibutton not_enabled reorder_pages_confirm_input default">Save Page Order</div>    <div class="minibutton close_editor">Cancel</div>  </div>  <div class="editor_hint">Reorder pages by dragging and dropping.</div>  </div>');
window.JST.replace_pages=_.template('<div class="replace_pages">    <div class="editor_toolbar_controls replace_pages_holder">    <form id="new_document_form" action="/import/upload_document" method="POST" enctype="multipart/form-data" target="upload_iframe">      <div class="minibutton plus replace_pages_upload_button default" id="new_document"><div class="icon white_plus"></div><div class="center">Upload Pages</div></div>      <button type="submit">Upload Pages</button>      <input id="new_document_input" name="file" type="file" multiple />      <iframe id="upload_iframe" name="upload_iframe" src="about:blank" class="hidden_iframe"></iframe>    </form>    <div class="minibutton close_editor">Cancel</div>  </div>    <div class="editor_hint"></div>  </div>');
window.JST.reviewer_welcome=_.template(' Use the links at the right to annotate the document. Keep in mind that any other reviewers will be able to see public annotations and drafts. Private annotations are for your own reference. Even <%= fullName %> can\'t see them.  <br><br>  Contact <%= fullName %> at <a href="mailto:<%= email %>" class="text_link"><%= email %></a> if you need any help, or visit <a href="http://www.documentcloud.org" class="text_link">http://www.documentcloud.org</a> for more information about DocumentCloud.');
window.JST.section_row=_.template('<li class="section_row">  <div style="position:relative;">    <div class="text_input dark small">      <input class="section_title" type="text" placeholder="Title&hellip;" value="" />    </div>    <div class="text_input dark small">      <span class="page_number_mark">p.</span>      <input class="page_number" type="text" value="<%= page_number %>" />    </div>    <div class="icon minus"></div>    <div class="icon plus"></div>    <br class="clear" />  </div></li>')})();
