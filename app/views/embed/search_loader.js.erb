(function() {
  // If the embed is already loaded, don't repeat the process.
  if (window.dc && window.dc.loaded) return;

  <% root = DC.server_root(:ssl => false) %>
  window.dc = window.dc || {};

  var loadCSS = function(url, media) {
    var link   = document.createElement('link');
    link.rel   = 'stylesheet';
    link.type  = 'text/css';
    link.media = media || 'screen';
    link.href  = url;
    var head   = document.getElementsByTagName('head')[0];
    head.appendChild(link);
  };

  loadCSS('<%= root %>/embed/search_embed.css');

  dc.afterLoad = function(viewer) {
    var loc = window.location;
    var url = loc.protocol + '//' + loc.host + loc.pathname + loc.search;
    if (url.match(/^file:/)) return false;
    url = url.replace(/[\/]+$/, '');
    var id  = parseInt(viewer.api.getId(), 10);
    var key = encodeURIComponent(id + ':' + url);
    dc.jQuery(document.body).append('<img alt="" width="1" height="1" src="<%= root.sub("s3", "www") %>/pixel.gif?key=' + key + '" />');
  };

  // Record the fact that the embed is loaded.
  dc.loaded = true;

  // Request the embed JavaScript.
  document.write('<%= include_javascripts(:search_embed).gsub(/\n/, '') %>');
})();
