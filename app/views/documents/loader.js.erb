(function() {
  <% root = DC.server_root(:ssl => false) %>
  window.DV = window.DV || {};

  var loadCSS = function(url) {
    var link  = document.createElement('link');
    link.rel  = 'stylesheet';
    link.type = 'text/css';
    link.href = url;
    var head  = document.getElementsByTagName('head')[0];
    head.appendChild(link);
  };

  /*@cc_on
  /*@if (@_jscript_version < 5.8)
    loadCSS('<%= root %>/viewer/viewer.css');
  @else @*/
    loadCSS('<%= root %>/viewer/viewer-datauri.css');
  /*@end
  @*/
  loadCSS('<%= root %>/viewer/plainviewer.css');

  DV.onload = function() {
    // Nasty hack to fix viewer for embeds that had position:relative set.
    if (DV.options && DV.options.container) {
      var cont = $j(DV.options.container);
      if (cont.length && (cont.css('position') == 'relative') && (cont.height() < 50)) {
        cont.css({position : 'static'});
      }
    }
  };

  DV.afterLoad = function() {
    $j('#DV-logoLink').attr({href : 'http://www.documentcloud.org'});
    var loc = window.location;
    var url = loc.protocol + '//' + loc.host + loc.pathname;
    if (url.match(/^file:/)) return false;
    url = url.replace(/[\/]+$/, '');
    var id  = parseInt(DV.Schema.document.id, 10);
    var key = encodeURIComponent(id + ':' + url);
    $j(document.body).append('<img alt="" width="1" height="1" src="<%= root.sub("s3", "www") %>/pixel.gif?key=' + key + '" />');
  };

  document.write('<script type="text/javascript" src="<%= root %>/viewer/viewer.js"></script>');
})();
